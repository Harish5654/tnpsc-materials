<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download GK Notes - TNPSC Materials</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #119989 0%, #38ef3d 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .download-container { background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .success-icon { font-size: 5rem; margin-bottom: 20px; animation: bounce 0.5s ease; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    h1 { color: #2e7d32; font-size: 2rem; margin-bottom: 15px; }
    .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 30px; }
    .order-details { background: #f9f9f9; border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: left; }
    .order-details h3 { color: #119989; margin-bottom: 15px; }
    .order-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .order-row:last-child { border-bottom: none; }
    .order-label { color: #666; }
    .order-value { font-weight: bold; color: #333; }
    .download-btn { display: inline-block; background: linear-gradient(135deg, #119989 0%, #38ef3d 100%); color: white; padding: 18px 50px; border-radius: 30px; text-decoration: none; font-size: 1.2rem; font-weight: bold; transition: transform 0.3s, box-shadow 0.3s; margin-bottom: 15px; border: none; cursor: pointer; }
    .download-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(17 1553 11,2 0.5); }
    .download-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .home-btn { display: inline-block; background: transparent; border: 2px solid #119989; color: #119988; padding: 12px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; transition: all 0.3s; }
    .home-btn:hover { background: #119988; color: white; }
    .whatsapp-support { margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 15px; }
    .whatsapp-support p { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
    .whatsapp-btn { display: inline-block; background: #25d366; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #119988; border-radius: 50%; animation: spin 1s linear infinite; margin: 30px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-container { background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .error-icon { font-size: 4rem; margin-bottom: 20px; }
    .error-container h1 { color: #ff4757; }
    .retry-btn { display: inline-block; background: #ff4757; color: white; padding: 14px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; margin-top: 20px; }
    .pdf-list { text-align: left; max-height: 200px; overflow-y: auto; margin-top: 15px; }
    .pdf-item { padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .pdf-name { font-size: 0.9rem; color: #333; }
    .pdf-size { font-size: 0.8rem; color: #888; }
    .product-badge { display: inline-block; background: linear-gradient(135deg, #119988 0%, #38ef3d 100%); color: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="download-container" id="page-content">
    <div class="loading-spinner"></div>
    <h1>Verifying Access...</h1>
    <p class="subtitle">Please wait while we verify your purchase.</p>
  </div>

<script>
    var API_URL = '/api';
    var params = new URLSearchParams(window.location.search);
    var orderId = params.get('order') || params.get('orderId') || params.get('order_id');
    
    // Product info for this page
    var PRODUCT_ID = 'prod_002';
    var PRODUCT_NAME = 'General Knowledge Notes';
    var DOWNLOAD_PAGE = '/gk-download';
    
    // Check if user has valid order
    function verifyAccess() {
      if (!orderId) {
        // Check localStorage for order
        try {
          var pendingOrder = JSON.parse(localStorage.getItem('pending_order'));
          if (pendingOrder && pendingOrder.orderId) {
            orderId = pendingOrder.orderId;
          }
        } catch(e) {}
      }
      
      if (orderId) {
        verifyOrder(orderId);
      } else {
        showErrorPage();
      }
    }
    
    function verifyOrder(orderId) {
      fetch(API_URL + '/order/' + orderId)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.downloadReady && data.product) {
            // Verify this is the correct product
            if (data.product.id === PRODUCT_ID || data.order.productId === PRODUCT_ID) {
              showDownloadPage(data);
            } else {
              // Wrong product - redirect to correct download page
              var redirectMap = {
                'prod_001': '/tamil-download',
                'prod_003': '/combo-download'
              };
              var redirectUrl = redirectMap[data.order.productId] || '/products';
              window.location.href = redirectUrl + '?order=' + orderId;
            }
          } else {
            showErrorPage();
          }
        })
        .catch(function(err) {
          console.error('Error:', err);
          showErrorPage();
        });
    }
    
    function showDownloadPage(data) {
      var container = document.getElementById('page-content');
      var orderId = data.order.id;
      
      container.innerHTML = 
        '<div class="success-icon">‚úÖ</div>' +
        '<div class="product-badge">üåç ' + data.product.name + '</div>' +
        '<h1>Payment Successful!</h1>' +
        '<p class="subtitle">Your PDF notes are ready for download instantly.</p>' +
        '<div class="order-details">' +
        '<h3>üìã Order Information</h3>' +
        '<div class="order-row"><span class="order-label">Order ID:</span><span class="order-value">' + data.order.id.substring(0, 12) + '...</span></div>' +
        '<div class="order-row"><span class="order-label">Product:</span><span class="order-value">' + data.product.name + '</span></div>' +
        '<div class="order-row"><span class="order-label">Amount Paid:</span><span class="order-value">‚Çπ' + data.order.amount + '</span></div>' +
        '<div class="order-row"><span class="order-label">Purchase Date:</span><span class="order-value">' + new Date(data.order.createdAt).toLocaleDateString('en-IN') + '</span></div>' +
        '</div>' +
        '<div id="pdf-list-container"><p>Loading files...</p></div>' +
        '<div style="background:#e3f2fd;border-left:4px solid #2196F3;padding:15px;border-radius:8px;margin:20px 0;text-align:left;">' +
        '<h4 style="color:#1976D2;margin-bottom:8px;">üí° Download Options</h4>' +
        '<p style="color:#555;font-size:0.95rem;margin:0;">‚Ä¢ Click individual PDFs above to download specific files</p>' +
        '<p style="color:#555;font-size:0.95rem;margin:8px 0 0 0;">‚Ä¢ Or download all files as one ZIP archive below</p>' +
        '</div>' +
        '<button onclick="downloadAllAsZip(\'" + orderId + "\')" class="download-btn" id="download-all-btn" style="width:100%;cursor:pointer;">üì¶ Download All as ZIP</button>' +
        '<br><br>' +
        '<div style="background:#fff3e0;border-left:4px solid #FF9800;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;">' +
        '<h4 style="color:#E65100;margin-bottom:8px;">üìå Important Notes</h4>' +
        '<p style="color:#555;font-size:0.9rem;margin:0;">‚úì Your files are available for 30 days</p>' +
        '<p style="color:#555;font-size:0.9rem;margin:8px 0 0 0;">‚úì You can download multiple times</p>' +
        '</div>' +
        '<a href="/products" class="home-btn">‚Üê Browse More Products</a>' +
        '<div class="whatsapp-support">' +
        '<p>Need help? Contact us on WhatsApp:</p>' +
        '<a href="https://wa.me/918072563583" class="whatsapp-btn" target="_blank">üí¨ Chat on WhatsApp</a>' +
        '</div>';
      
      loadPdfList(orderId);
    }
    
    function downloadAllAsZip(orderId) {
      var btn = document.getElementById('download-all-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Preparing ZIP...';
      
      var link = document.createElement('a');
      link.href = '/download-all/' + orderId;
      link.download = 'TNPSC_Notes_' + orderId + '.zip';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      setTimeout(function() {
        btn.disabled = false;
        btn.textContent = 'üì¶ Download All as ZIP';
      }, 2000);
    }
    
    function loadPdfList(orderId) {
      fetch(API_URL + '/order-pdfs/' + orderId)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          var container = document.getElementById('pdf-list-container');
          
          if (data.files && data.files.length > 0) {
            var html = '<div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:20px;text-align:left;">' +
              '<h4 style="margin-bottom:15px;color:#333;">üìÑ Included PDFs (' + data.files.length + ' files):</h4>' +
              '<div class="pdf-list">';
            
            data.files.forEach(function(file) {
              var sizeMB = (file.size / (1024 * 1024)).toFixed(2);
              var fileNum = data.files.indexOf(file) + 1;
              html += '<div class="pdf-item" style="background:white;border:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;padding:12px;">' +
                '<div style="flex:1;">' +
                '<div class="pdf-name" style="font-weight:500;margin-bottom:4px;">üìë ' + file.name + '</div>' +
                '<div class="pdf-size" style="font-size:0.8rem;color:#999;">Size: ' + sizeMB + ' MB</div>' +
                '</div>' +
                '<a href="/download/' + orderId + '?file=' + fileNum + '" style="background:#119989;color:white;padding:8px 12px;border-radius:6px;text-decoration:none;font-size:0.85rem;white-space:nowrap;margin-left:10px;transition:background 0.3s;" onmouseover="this.style.background=\'#038a72\'" onmouseout="this.style.background=\'#119989\'">‚¨áÔ∏è Download</a>' +
                '</div>';
            });
            
            html += '</div></div>';
            container.innerHTML = html;
          } else {
            container.innerHTML = '<p style="color:#666;">Your PDF files are being prepared. Click the download button below.</p>';
          }
        })
        .catch(function(err) {
          console.error('Error loading PDF list:', err);
          document.getElementById('pdf-list-container').innerHTML = '<p style="color:#666;">Click the button below to download your PDFs.</p>';
        });
    }
    
    function showErrorPage() {
      document.getElementById('page-content').innerHTML = 
        '<div class="error-container">' +
        '<div class="error-icon">üîí</div>' +
        '<h1>Access Denied</h1>' +
        '<p class="subtitle">Please complete the payment to access the materials.</p>' +
        '<a href="/products" class="retry-btn">Buy Now</a>' +
        '<br><br>' +
        '<a href="/" class="home-btn">‚Üê Back to Home</a>' +
        '<div class="whatsapp-support">' +
        '<p>Need help? Contact us on WhatsApp:</p>' +
        '<a href="https://wa.me/918072563583" class="whatsapp-btn" target="_blank">üí¨ Chat on WhatsApp</a>' +
        '</div>';
    }
    
    // Initialize
    verifyAccess();
  </script>
</body>
</html>
