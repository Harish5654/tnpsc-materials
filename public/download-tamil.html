<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download Tamil Notes - TNPSC Materials</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .download-container { background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .success-icon { font-size: 5rem; margin-bottom: 20px; animation: bounce 0.5s ease; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    h1 { color: #2e7d32; font-size: 2rem; margin-bottom: 15px; }
    .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 30px; }
    .order-details { background: #f9f9f9; border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: left; }
    .order-details h3 { color: #667eea; margin-bottom: 15px; }
    .order-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .order-row:last-child { border-bottom: none; }
    .order-label { color: #666; }
    .order-value { font-weight: bold; color: #333; }
    .download-btn { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 50px; border-radius: 30px; text-decoration: none; font-size: 1.2rem; font-weight: bold; transition: transform 0.3s, box-shadow 0.3s; margin-bottom: 15px; border: none; cursor: pointer; width: 100%; }
    .download-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
    .download-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .home-btn { display: inline-block; background: transparent; border: 2px solid #667eea; color: #667eea; padding: 12px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; transition: all 0.3s; }
    .home-btn:hover { background: #667eea; color: white; }
    .whatsapp-support { margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 15px; }
    .whatsapp-support p { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
    .whatsapp-btn { display: inline-block; background: #25d366; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 30px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-container { background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .error-icon { font-size: 4rem; margin-bottom: 20px; }
    .error-container h1 { color: #ff4757; }
    .retry-btn { display: inline-block; background: #ff4757; color: white; padding: 14px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; margin-top: 20px; }
    .pdf-list { text-align: left; margin-top: 15px; }
    .pdf-item { padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .pdf-name { font-weight: 500; }
    .pdf-size { font-size: 0.8rem; color: #999; }
    .product-badge { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="download-container" id="page-content">
    <div class="loading-spinner"></div>
    <h1>Loading Your Download...</h1>
    <p class="subtitle">Please wait while we prepare your files.</p>
  </div>

  <script>
    const API_URL = '/api';
    const PRODUCT_ID = 'prod_001';
    const PRODUCT_NAME = 'General Tamil Notes';
    
    // Get order ID from URL parameter
    const params = new URLSearchParams(window.location.search);
    let orderId = params.get('order') || params.get('orderId');
    
    // Also check localStorage in case it was stored from checkout
    if (!orderId) {
      try {
        const stored = JSON.parse(localStorage.getItem('verified_order'));
        if (stored && stored.productId === PRODUCT_ID) {
          orderId = stored.orderId;
        }
      } catch(e) {}
    }
    
    // Check if we just came from payment success
    if (!orderId && window.location.hash) {
      try {
        const hashData = JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
        if (hashData.orderId) {
          orderId = hashData.orderId;
        }
      } catch(e) {}
    }
    
    function loadPage() {
      if (!orderId) {
        showErrorPage('No order found. Please complete a payment first.');
        return;
      }
      
      // Fetch order details
      fetch(API_URL + '/order/' + orderId)
        .then(res => res.json())
        .then(data => {
          if (data.downloadReady && data.product) {
            showDownloadPage(data);
          } else {
            showErrorPage('Order not found or payment not completed.');
          }
        })
        .catch(err => {
          showErrorPage('Error loading order: ' + err.message);
        });
    }
    
    function showDownloadPage(data) {
      const container = document.getElementById('page-content');
      
      container.innerHTML = 
        '<div class="success-icon">‚úÖ</div>' +
        '<div class="product-badge">üìö ' + data.product.name + '</div>' +
        '<h1>Payment Successful!</h1>' +
        '<p class="subtitle">Your PDF notes are ready for download instantly.</p>' +
        '<div class="order-details">' +
        '<h3>üìã Order Information</h3>' +
        '<div class="order-row"><span class="order-label">Order ID:</span><span class="order-value">' + data.order.id.substring(0, 12) + '...</span></div>' +
        '<div class="order-row"><span class="order-label">Product:</span><span class="order-value">' + data.product.name + '</span></div>' +
        '<div class="order-row"><span class="order-label">Amount Paid:</span><span class="order-value">‚Çπ' + data.order.amount + '</span></div>' +
        '</div>' +
        '<div id="pdf-list-container"><p>Loading files...</p></div>' +
        '<button onclick="downloadAllAsZip(\'' + data.order.id + '\')" class="download-btn" id="download-all-btn">üì¶ Download All</button>' +
        '<br><br>' +
        '<a href="/products" class="home-btn">‚Üê Back to Shop</a>' +
        '<div class="whatsapp-support">' +
        '<p>Need help? Contact us on WhatsApp:</p>' +
        '<a href="https://wa.me/918072563583" class="whatsapp-btn" target="_blank">üí¨ Chat on WhatsApp</a>' +
        '</div>';
      
      loadPdfList(data.order.id);
    }
    
    function loadPdfList(orderId) {
      fetch(API_URL + '/order-pdfs/' + orderId)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('pdf-list-container');
          
          if (data.files && data.files.length > 0) {
            let html = '<div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:20px;text-align:left;">' +
              '<h4 style="margin-bottom:15px;">üìÑ Included PDFs (' + data.files.length + ' files):</h4>' +
              '<div class="pdf-list">';
            
            data.files.forEach((file, idx) => {
              const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
              html += '<div class="pdf-item"><div><div class="pdf-name">üìë ' + file.name + '</div><div class="pdf-size">Size: ' + sizeMB + ' MB</div></div><a href="/download/' + orderId + '?file=' + (idx + 1) + '" style="background:#667eea;color:white;padding:8px 12px;border-radius:6px;text-decoration:none;font-size:0.85rem;white-space:nowrap;">‚¨áÔ∏è Download</a></div>';
            });
            
            html += '</div></div>';
            container.innerHTML = html;
          } else {
            container.innerHTML = '<p style="color:#666;">Click download button to get your files.</p>';
          }
        })
        .catch(err => {
          console.error('Error loading PDFs:', err);
          document.getElementById('pdf-list-container').innerHTML = '<p>Click download button to get your files.</p>';
        });
    }
    
    function downloadAllAsZip(orderId) {
      const btn = document.getElementById('download-all-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Preparing ZIP...';
      
      const link = document.createElement('a');
      link.href = '/download-all/' + orderId;
      link.download = 'TNPSC_Notes_' + orderId + '.zip';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'üì¶ Download All';
      }, 2000);
    }
    
    function showErrorPage(msg) {
      document.getElementById('page-content').innerHTML = 
        '<div class="error-container">' +
        '<div class="error-icon">üîí</div>' +
        '<h1>Access Denied</h1>' +
        '<p class="subtitle">' + msg + '</p>' +
        '<a href="/products" class="retry-btn">Browse Products</a>' +
        '<br><br>' +
        '<a href="/" class="home-btn">‚Üê Back to Home</a>' +
        '</div>';
    }
    
    // Load on page ready
    loadPage();
  </script>
</body>
</html>
