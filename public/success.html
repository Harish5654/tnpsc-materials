<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Successful - TNPSC Materials</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úÖ</text></svg>">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .success-container { background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .success-icon { font-size: 5rem; margin-bottom: 20px; animation: bounce 0.5s ease; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    h1 { color: #2e7d32; font-size: 2rem; margin-bottom: 15px; }
    .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 30px; }
    .order-details { background: #f9f9f9; border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: left; }
    .order-details h3 { color: #667eea; margin-bottom: 15px; }
    .order-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .order-row:last-child { border-bottom: none; }
    .order-label { color: #666; }
    .order-value { font-weight: bold; color: #333; }
    .download-btn { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 40px; border-radius: 30px; text-decoration: none; font-size: 1.1rem; font-weight: bold; transition: transform 0.3s, box-shadow 0.3s; margin-bottom: 15px; }
    .download-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
    .home-btn { display: inline-block; background: transparent; border: 2px solid #667eea; color: #667eea; padding: 12px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; transition: all 0.3s; }
    .home-btn:hover { background: #667eea; color: white; }
    .whatsapp-support { margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 15px; }
    .whatsapp-support p { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
    .whatsapp-btn { display: inline-block; background: #25d366; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #4caf50; border-radius: 50%; animation: spin 1s linear infinite; margin: 30px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-container { background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .error-icon { font-size: 4rem; margin-bottom: 20px; }
    .error-container h1 { color: #ff4757; }
    .retry-btn { display: inline-block; background: #ff4757; color: white; padding: 14px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="success-container" id="page-content">
    <div class="loading-spinner"></div>
    <h1>Verifying Payment...</h1>
    <p class="subtitle">Please wait while we verify your payment.</p>
  </div>

  <script>
    var API_URL = '/api';
    var params = new URLSearchParams(window.location.search);
    var orderId = params.get('order');
    var productId = params.get('product_id');
    var status = params.get('status');
    
    if (status === 'failed') {
      showFailedPage();
    } else if (orderId) {
      verifyOrder(orderId);
    } else {
      showWelcomePage();
    }
    
    function showFailedPage() {
      document.getElementById('page-content').innerHTML = 
        '<div class="error-container">' +
        '<div class="error-icon">‚ùå</div>' +
        '<h1>Payment Failed</h1>' +
        '<p class="subtitle">Your payment was not completed. Please make a payment to access the notes.</p>' +
        '<a href="/products" class="retry-btn">Try Again</a>' +
        '</div>';
    }
    
    function showWelcomePage() {
      document.getElementById('page-content').innerHTML = 
        '<div class="success-icon">üéâ</div>' +
        '<h1>Welcome!</h1>' +
        '<p class="subtitle">Thank you for your purchase!</p>' +
        '<a href="/products" class="home-btn">Browse More Products</a>';
    }
    
    function verifyOrder(orderId) {
      fetch(API_URL + '/order/' + orderId)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.downloadReady && data.product) {
            showSuccessPage(data);
          } else {
            showErrorPage();
          }
        })
        .catch(function(err) {
          console.error('Error:', err);
          showErrorPage();
        });
    }
    
    function showSuccessPage(data) {
      var container = document.getElementById('page-content');
      var orderId = data.order.id;
      
      container.innerHTML = 
        '<div class="success-icon">‚úÖ</div>' +
        '<h1>Payment Successful!</h1>' +
        '<p class="subtitle">Your PDF notes are ready for download.</p>' +
        '<div class="order-details">' +
        '<h3>üìã Order Details</h3>' +
        '<div class="order-row"><span class="order-label">Order ID:</span><span class="order-value" id="order-id"></span></div>' +
        '<div class="order-row"><span class="order-label">Product:</span><span class="order-value" id="product-name"></span></div>' +
        '<div class="order-row"><span class="order-label">Amount Paid:</span><span class="order-value" id="amount-paid"></span></div>' +
        '</div>' +
        '<div id="pdf-list-container"><p>Loading your PDFs...</p></div>' +
        '<a href="/download-all/' + orderId + '" class="download-btn" id="download-all-btn" style="display:none;">üì¶ Download All as ZIP</a>' +
        '<br><br>' +
        '<a href="/products" class="home-btn">‚Üê Browse More Products</a>' +
        '<div class="whatsapp-support">' +
        '<p>Need help? Contact us on WhatsApp:</p>' +
        '<a href="https://wa.me/918072563583" class="whatsapp-btn" target="_blank">üí¨ Chat on WhatsApp</a>' +
        '</div>';
      
      document.getElementById('order-id').textContent = data.order.id;
      document.getElementById('product-name').textContent = data.product.name;
      document.getElementById('amount-paid').textContent = '‚Çπ' + data.order.amount;
      
      loadPdfList(orderId);
    }
    
    function loadPdfList(orderId) {
      fetch(API_URL + '/order-pdfs/' + orderId)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          var container = document.getElementById('pdf-list-container');
          var downloadBtn = document.getElementById('download-all-btn');
          
          if (data.files && data.files.length > 0) {
            var html = '<div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:15px;text-align:left;">' +
              '<h4 style="margin-bottom:10px;">üìÑ Included PDFs (' + data.files.length + ' files):</h4>' +
              '<ul style="margin:0;padding-left:20px;color:#555;font-size:0.9rem;max-height:200px;overflow-y:auto;">';
            
            data.files.forEach(function(file) {
              var sizeMB = (file.size / (1024 * 1024)).toFixed(2);
              html += '<li style="margin-bottom:5px;">' + file.name + ' <span style="color:#888;">(' + sizeMB + ' MB)</span></li>';
            });
            
            html += '</ul></div>';
            container.innerHTML = html;
            downloadBtn.style.display = 'inline-block';
          } else {
            container.innerHTML = '<p style="color:#666;">Click below to download your PDFs.</p>';
            downloadBtn.style.display = 'inline-block';
          }
        })
        .catch(function(err) {
          console.error('Error loading PDF list:', err);
          document.getElementById('pdf-list-container').innerHTML = '<p style="color:#666;">Click below to download your PDFs.</p>';
          document.getElementById('download-all-btn').style.display = 'inline-block';
        });
    }
    
    function showErrorPage() {
      document.getElementById('page-content').innerHTML = 
        '<div class="error-container">' +
        '<div class="error-icon">‚ö†Ô∏è</div>' +
        '<h1>Order Not Found</h1>' +
        '<p class="subtitle">Please contact support with your payment details.</p>' +
        '<a href="https://wa.me/918072563583" class="whatsapp-btn" target="_blank">üí¨ Contact Support</a>' +
        '</div>';
    }
  </script>
</body>
</html>
